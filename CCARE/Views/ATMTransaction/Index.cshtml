@{
    if (Request.IsAjaxRequest())
    {
        Layout = null;
    }
}

<ul class="nav nav-stacked nav-pills">
    <li class="titleBar font-crm4"><a></a></li>
</ul>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">

            <br />
            
            <ol class="breadcrumb">
                <li class="active">Search</li>
                <li class="active">Product Transactions</li>
                <li class="active"><a href="#">ATM</a></li>
            </ol>
            
            <!-- Content -->
            <div class="container-fluid content_container">
                <div class="row">
                    <div class="col-sm-12">
                        <form id="form_inquiry">
                            <ul id="myTab" class="nav nav-tabs">
                                <li class="active"><a href="#history" id="history-tab" data-toggle="tab" class="transactionTab tab-trx">History</a></li>
                                <li><a href="#current" id="current-tab" data-toggle="tab" class="transactionTab tab-trx">Current</a></li>
                            </ul>
                            <br />
                            <input type="hidden" id="Date2" value="" />
                            <div class="tab-content myContent_Tab">
                                <div class="tab-pane fade active in" id="history" aria-labelledby="history-tab">
                                    <ol class="breadcrumb br-trx">
                                        <li class="active"><a href="#" id="linkUpdate">Update</a><span id="labelUpdate">Update</span></li>
                                        <li class="active"><a href="#" id="linkClear">Clear</a></li>
                                        <li class="active"><a href="#" id="linkSearch">Quick Search</a><span id="labelSearch">Quick Search</span></li>
                                        <li class="active"><a href="#" id="linkTerminalSearch">Terminal Search</a><span id="labelTerminalSearch">Terminal Search</span></li>
                                        <li class="active"><a href="#" id="linkPrint">Print</a><span id="labelPrint">Print</span></li>
                                    </ol>
                                    <div class="form-horizontal">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label mandatory2">No Kartu</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="CardNo" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label mandatory">Tanggal</label>
                                                    <div class="col-sm-9">
                                                        <div class="input-group" id="divDateTimePicker">
                                                            <input type="text" class="form-control" id="TransDate1" />
                                                            <span class="input-group-addon">
                                                                <i class="fa fa-calendar fa-lg"></i>
                                                            </span>
                                                            <span class="input-group-btn input_space"></span>
                                                            <input type="text" class="form-control" id="TransDate2" />
                                                            <span class="input-group-addon">
                                                                <i class="fa fa-calendar fa-lg"></i>
                                                            </span>
                                                        </div>
                                                        <div class="input-group" id="divDateTextBox">
                                                            <input type="text" class="form-control" id="TransactionDate" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label mandatory2">Dari Rekening</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="FromAccount" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Ke Rekening</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="ToAccount" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Terminal</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="Terminal" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Lokasi</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="Location" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Kode Tran</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="TransactionCode" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Jenis Transaksi</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="TransactionDescription" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Kode Response</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="ResponseCode" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Response</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="Response" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Mata Uang</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="Currency" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Kurs</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="Rate" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Jumlah Rupiah</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="Amount" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Jumlah Valas</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="Forex" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Perusahaan</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="Company" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Sequence</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="Sequence" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-offset-6 col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">Request ID</label>
                                                    <div class="col-sm-9">
                                                        @*<input type="text" class="form-control" id="RequestID"/>*@
                                                        @* ==========================================================================================================*@
                                                        <input type="hidden" id="RequestID" name="" class="form-control"/>
                                                        <div class="input-group" id="Request-Group">
                                                            <input type="text" id="TicketNumber" name="RequestID" class="form-control" value="">
                                                            <div tabindex="0" id="TicketNumber-label" class="form-control typeahead-label hide">
                                                            </div>
                                                            <div tabindex="0" class="input-group-addon btn" id="TicketNumber-popup">
                                                                <i class="fa fa-search"></i>
                                                            </div>
                                                        </div>
                                                        @* ==========================================================================================================*@
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                @*===================================CURRENT TAB===================================*@
                                <div class="tab-pane fade" id="current" aria-labelledby="current-tab">
                                    <div class="form-horizontal" style="padding-top: 10px; padding-right: 60px;">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-4 control-label">No Kartu ATM</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" class="form-control" id="ATMCardNo" value="" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">FIID</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="FIID" value="BCA" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-4 control-label">Tgl Trx</label>
                                                    <div class="col-sm-8">
                                                        <div class="input-group date">
                                                            <input type="text" class="form-control" id="TransDate" />
                                                            <span class="input-group-addon">
                                                                <i class="fa fa-calendar fa-lg"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">LNET</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="LNET" value="PRO1" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-4 control-label">Terminal ID (opt)</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" class="form-control" id="TerminalID" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <div class="col-sm-4"></div>
                                                    <div class="col-sm-8">
                                                        <div class="input-group">
                                                            <button class="btn btn-primary btn-crm-layout" type="button" id="btnSearchCurrent">
                                                                <span class="glyphicon glyphicon-search glyp-space" aria-hidden="true"></span>
                                                                Search
                                                            </button>
                                                            <button class="btn btn-danger btn-crm-layout" type="button" id="btnCancelCurrent">
                                                                <span class="glyphicon glyphicon-erase glyp-space" aria-hidden="true"></span>
                                                                Clear
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <br />

                <!-- Table result -->
                <div class="row" id="DivResult">
                    <div class="col-sm-12">
                        <div class="panel panel-default">
                            <div class="panel-heading panel_heading">
                                <label class="control-label sv-header">
                                    <strong>Search Result</strong>
                                </label>
                            </div>
                            <div class="panel-body">
                                <div class="divGrid">
                                    <table id="gridTable"></table>
                                    <div id="jqGridPager"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="response-modal"></div>

<script type="text/javascript">
    $(document).ready(function () {
        var gridId = "#gridTable";
        var entityName = '@ViewContext.RouteData.Values["Controller"].ToString()';
        //$("input[name=RequestID]").prop("disabled", true);

        $("#DivResult").hide();
        $("#divDateTextBox").hide();
        $("#labelSearch").hide();
        $("#linkUpdate").hide();
        $("#linkPrint").hide();
        $("#linkTerminalSearch").hide();

        $("input[type=text]").prop("readonly", true);
        $("#CardNo").prop("readonly", false);
        $("#TransDate1").prop("readonly", false);
        $("#TransDate2").prop("readonly", false);
        $("#FromAccount").prop("readonly", false);
        $("#Terminal").prop("readonly", false);

        $("#TransDate1").datepicker({
            format: "dd/mm/yyyy",
            autoclose: true
        });

        $("#TransDate2").datepicker({
            format: "dd/mm/yyyy",
            autoclose: true
        });

        $("#TransDate").datepicker({
            format: "dd/mm/yyyy",
            autoclose: true
        });

        $(".transactionTab").click(function (event) {
            $("#linkClear").click();
            $("#FIID").prop("readonly", false);
            $("#ATMCardNo").prop("readonly", false);
            $("#LNET").prop("readonly", false);
            $("#TransDate").prop("readonly", false);
            $("#TerminalID").prop("readonly", false);
            $("#FIID").val("BCA");
            $("#LNET").val("PRO1");
            $("#TransDate").datepicker('setDate', new Date());
            $.jgrid.gridUnload("#gridTable");
        });

        $('#linkSearch').click(function (event) {
            (event.preventDefault) ? event.preventDefault() : event.returnValue = false;

            if ($("#CardNo").val() == "" && $("#FromAccount").val() == "") {
                alert("@Resources.ProductTransactions.MandatoryCardNo_FromAccount");
                return false;
            }
            if ($("#TransDate1").val() == "") {
                alert("@Resources.ProductTransactions.MandatoryStartDate");
                return false;
            }
            @*if ($("#TransDate1").val() == $("#TransDate2").val() ) {
                alert("@Resources.ProductTransactions.DifferentDate");
                return false;
            }*@

            //if (Date.parse($("#TransDate1").val()) > Date.parse($("#TransDate2").val())) {
            if (CheckRangeDate($("#TransDate1").val(), $("#TransDate2").val())) {
                alert("@Resources.ProductTransactions.DateIsNotValid");
                return false;
            }

            $("#DivResult").show();
            var postData = {
                TransDate1: function () { return $("#TransDate1").val(); },
                TransDate2: function () { return $("#TransDate2").val(); },
                CardNo: function () { return $("#CardNo").val(); },
                FromAccount: function () { return $("#FromAccount").val(); },
                Tab: "History",
                SearchTerminalID: ""
            };
            loadJqgrid(gridId, postData, entityName);

            $("input[type=text]").prop("readonly", true);
            $("#TransDate1").datepicker("disable");
            $("#TransDate2").datepicker("disable");

            $("#linkSearch").hide();
            $("#labelSearch").show();
            $("#linkPrint").show();
            $("#labelPrint").hide();
        });

        $('#linkClear').click(function (event) {
            $("#DivResult").hide();
            $("input[type=text]").prop("readonly", true);
            $("#CardNo").prop("readonly", false);
            $("#TransDate1").prop("readonly", false);
            $("#TransDate2").prop("readonly", false);
            $("#FromAccount").prop("readonly", false);
            $("#Terminal").prop("readonly", false);
            $("input[type=text]").val("");
            $("#divDateTextBox").hide();
            $("#divDateTimePicker").show();
            $("#linkSearch").show();
            $("#labelSearch").hide();
            $("#linkUpdate").hide();
            $("#labelUpdate").show();
            $("#linkPrint").hide();
            $("#labelPrint").show();
            $("#linkTerminalSearch").hide();
            $("#labelTerminalSearch").show();
            $("input[name=RequestID]").val("");
            $("#TicketNumber-label").text("");
        });

        $('#linkUpdate').click(function (event) {
            (event.preventDefault) ? event.preventDefault() : event.returnValue = false;

            if ($("input[name=RequestID]").val() == "") {
                alert("@Resources.ProductTransactions.MandatoryRequestID");
                return false;
            }
            var regexNumber = /^\d+$/;
            if (regexNumber.test($("input[name=RequestID]").val()) == false) {
                alert("@Resources.ProductTransactions.NumericRequestID");
                return false;
            }

            var postData = {
                CardNo: $("#CardNo").val(),
                TransactionDate: $("#Date2").val(),
                RequestID: $("input[name=RequestID]").val(),
                SequenceNo: $("#Sequence").val()
            };

            $.ajax({
                type: "POST",
                url: "/ATMTransaction/Update",
                data: "&CardNo=" + postData.CardNo + "&TransactionDate=" + postData.TransactionDate + "&SequenceNo=" + postData.SequenceNo + "&RequestID=" + postData.RequestID,
                dataType: "json",
                success: function (data) {
                    alert("Update Success");
                },
                error: function (xhr, status, err) {
                    alert("Error");
                }
            });

            $("#linkSearch").hide();
            $("#labelSearch").show();
            $("#linkUpdate").show();
            $("#labelUpdate").hide();
            $("#linkPrint").show();
            $("#labelPrint").hide();
            $("#linkTerminalSearch").show();
            $("#labelTerminalSearch").hide();
        });

        $('#linkTerminalSearch').click(function (event) {
            (event.preventDefault) ? event.preventDefault() : event.returnValue = false;

            $("#DivResult").show();
            var postData = {
                TerminalID: function () { return $("#Terminal").val(); },
                SequenceNo: function () { return $("#Sequence").val(); },
                Tab: "History",
                SearchTerminalID: "Yes"
            };
            loadJqgrid(gridId, postData, entityName);

            //disable all textbox
            $("input[type=text]").prop("readonly", true);
            $("input[name=RequestID]").prop("readonly", false);

            $("#linkSearch").hide();
            $("#labelSearch").show();
            $("#linkUpdate").show();
            $("#labelUpdate").hide();
            $("#linkPrint").show();
            $("#labelPrint").hide();
            $("#linkTerminalSearch").show();
            $("#labelTerminalSearch").hide();

        });

        //CURRENT
        $("#btnSearchCurrent").click(function (event) {
            (event.preventDefault) ? event.preventDefault() : event.returnValue = false;


            if ($("#ATMCardNo").val() == "") {
                alert("@Resources.ProductTransactions.MandatoryATMCardNo");
                return false;
            }
            if ($("#FIID").val() == "") {
                alert("@Resources.ProductTransactions.MandatoryFIID");
                return false;
            }
            if ($("#TransDate").val() == "") {
                alert("@Resources.ProductTransactions.MandatoryTglTrx");
                return false;
            }
            if ($("#LNET").val() == "") {
                alert("@Resources.ProductTransactions.MandatoryLNET");
                return false;
            }

            $("#DivResult").show();
            var postData = {
                TransDate: function () { return $("#TransDate").val(); },
                ATMNo: function () { return $("#ATMCardNo").val(); },
                FIID: function () { return $("#FIID").val(); },
                LNET: function () { return $("#LNET").val(); },
                TerminalID: function () { return $("#TerminalID").val(); },
                Tab: "Current"
            };
            loadJqgrid(gridId, postData, entityName);
        });


        $("#btnCancelCurrent").click(function (event) {
            $("#ATMCardNo").val("");
            $("#TerminalID").val("");
            $("#TransDate").val("");
            $("#FIID").val("BCA");
            $("#LNET").val("PRO1");
            $.jgrid.gridUnload("#gridTable");
        });

        $("#linkPrinta").click(function (e) {
            //getting values of current time for generating the file name
            var dt = new Date();
            var day = dt.getDate();
            var month = dt.getMonth() + 1;
            var year = dt.getFullYear();
            var hour = dt.getHours();
            var mins = dt.getMinutes();
            var postfix = day + "." + month + "." + year + "_" + hour + "." + mins;
            //creating a temporary HTML link element (they support setting file names)
            var a = document.createElement('a');
            //getting data from our div that contains the HTML table
            var data_type = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';//data:application/vnd.ms-excel
            var table_div = document.getElementById('gview_gridTable'); //gview_gridTable
            var table_html = table_div.outerHTML.replace(/ /g, '%20');
            a.href = data_type + ', ' + table_html;
            //setting the file name
            a.download = entityName + ' ' + postfix + '.xls';
            //triggering the function
            a.click();
            //just in case, prevent default behaviour
            e.preventDefault();
        });

        $("#linkPrint").click(function (e) {

            exportTableToCSV.apply(this, [$('#gview_gridTable>div>div>table'), 'export.csv']);
        });


        function exportTableToCSV($table, filename) {

            var $rows = $table.find('tr:has(td)'),

                // Temporary delimiter characters unlikely to be typed by keyboard
                // This is to avoid accidentally splitting the actual contents
                tmpColDelim = String.fromCharCode(11), // vertical tab character
                tmpRowDelim = String.fromCharCode(0), // null character

                // actual delimiter characters for CSV format
                colDelim = '","',
                rowDelim = '"\r\n"',

                // Grab text from table into CSV formatted string
                csv = '"' + $rows.map(function (i, row) {
                    var $row = $(row),
                        $cols = $row.find('td');

                    return $cols.map(function (j, col) {
                        var $col = $(col),
                            text = $col.text();

                        return text.replace(/"/g, '""'); // escape double quotes

                    }).get().join(tmpColDelim);

                }).get().join(tmpRowDelim)
                    .split(tmpRowDelim).join(rowDelim)
                    .split(tmpColDelim).join(colDelim) + '"',

                // Data URI
                csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

            $(this)
                .attr({
                    'download': filename,
                    'href': csvData,
                    'target': '_blank'
                });
        }

        @* =========================================Look Up Request=================================================*@
        $('#TicketNumber-popup').on('click', function (e) {
            urlModalPopup = '@Url.Action("_popupContent", "Popup", new { type = "requestTransaction", _entity = "" })';
            colModelsName = [
                { label: 'ID', name: 'Id', index: 'Id', key: true, width: 75, hidden: true },
                { label: 'Summary', name: 'Title', width: 200 },
                { label: 'Request ID', name: 'Name', width: 150 },
                { label: 'Category', name: 'CategoryName', width: 200 },
                { label: 'Product', name: 'ProductName', width: 200 },
                { label: 'Status', name: 'StatusLabel', width: 70 },
                { label: 'Created On', name: 'CreatedOn', width: 150, formatter: "date", formatoptions: { srcformat: "ISO8601Long", newformat: "d M Y h:i:s" } },
                { label: 'Due Date', name: 'DueDate', width: 150, formatter: "date", formatoptions: { srcformat: "ISO8601Long", newformat: "d M Y h:i:s" } }
            ];
            var id = $(this).parent().find('input:last').attr('id');
            $('#' + id).trigger("blur");
            e.preventDefault();
        });

        var requestTypeahead = new PopupClass();
        requestTypeahead.setId("TicketNumber");
        requestTypeahead.setUrl('@Url.Action("RequestLookUp", "Popup")');
        requestTypeahead.setHiddenId("RequestID");
        //requestTypeahead.setDependId("null_hidden");
        requestTypeahead.init();

        @* ==========================================================================================================*@
        $("input[name=RequestID]").removeClass("tt-input");
        $("input[type=text]").removeClass("tt-hint");
    });
</script>
